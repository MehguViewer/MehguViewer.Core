name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: [main, develop]

env:
  DOTNET_VERSION: '10.0.101'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  # ===========================================
  # Quick Validation
  # ===========================================
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Install .NET workloads
        run: |
          dotnet workload update --skip-sign-check
          dotnet workload install wasm-tools --skip-sign-check

      - name: Restore
        run: dotnet restore MehguViewer.sln

      - name: Build
        run: dotnet build MehguViewer.sln --configuration Debug

      - name: Run Unit Tests Only
        run: |
          dotnet test Tests/Tests.csproj \
            --configuration Debug \
            --no-build \
            --filter "Category!=Integration&Category!=E2E" \
            --logger "console;verbosity=normal"

  # ===========================================
  # PR Metadata Checks
  # ===========================================
  metadata:
    name: PR Metadata
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Size and Add Labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const changedFiles = pr.changed_files || 0;
            const totalChanges = additions + deletions;
            
            // Determine size label
            let sizeLabel = 'size/XS';
            let warning = '';
            
            if (totalChanges > 1000) {
              sizeLabel = 'size/XL';
              warning = '‚ö†Ô∏è **Large PR Warning**: This PR has over 1000 lines changed. Consider breaking it into smaller PRs for easier review.';
            } else if (totalChanges > 500) {
              sizeLabel = 'size/L';
              warning = 'üí° **PR Size Notice**: This PR is moderately large. Ensure it has a clear scope.';
            } else if (totalChanges > 200) {
              sizeLabel = 'size/M';
            } else if (totalChanges > 50) {
              sizeLabel = 'size/S';
            }
            
            // Try to add size label
            try {
              // Remove old size labels first
              const labels = pr.labels.map(l => l.name);
              const oldSizeLabels = labels.filter(l => l.startsWith('size/'));
              for (const label of oldSizeLabels) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label
                  });
                } catch (e) {
                  console.log(`Could not remove label ${label}:`, e.message);
                }
              }
              
              // Add new size label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [sizeLabel]
              });
            } catch (e) {
              console.log('Could not manage labels:', e.message);
            }
            
            // Create summary
            const summary = [
              '## PR Metadata Summary',
              '',
              '| Metric | Value |',
              '|--------|-------|',
              `| Size Label | \`${sizeLabel}\` |`,
              `| Lines Added | +${additions} |`,
              `| Lines Deleted | -${deletions} |`,
              `| Total Changes | ${totalChanges} |`,
              `| Files Changed | ${changedFiles} |`,
              '',
            ];
            
            if (warning) {
              summary.push(warning);
              summary.push('');
            }
            
            await core.summary.addRaw(summary.join('\n')).write();
            
            console.log(`PR Stats: +${additions} -${deletions}, ${changedFiles} files, Label: ${sizeLabel}`);

  # ===========================================
  # Commit Message Validation
  # ===========================================
  commits:
    name: Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Commit Messages
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: .commitlintrc.json
          failOnWarnings: false
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # File Changes Analysis
  # ===========================================
  changes:
    name: Analyze Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'MehguViewer.Core/**/*.cs'
              - 'MehguViewer.Core/**/*.csproj'
            ui:
              - 'MehguViewer.Core.UI/**/*.razor'
              - 'MehguViewer.Core.UI/**/*.cs'
              - 'MehguViewer.Core.UI/**/*.csproj'
            shared:
              - 'MehguViewer.Core.Shared/**/*.cs'
              - 'MehguViewer.Core.Shared/**/*.csproj'
            tests:
              - 'Tests/**/*.cs'
              - 'Tests/**/*.csproj'
            workflows:
              - '.github/workflows/**'
            docker:
              - 'Dockerfile'

      - name: Summary of Changes
        uses: actions/github-script@v7
        env:
          CHANGES: ${{ toJSON(steps.changes.outputs) }}
        with:
          script: |
            const changes = JSON.parse(process.env.CHANGES);
            
            const summary = [
              '## Changed Areas',
              '',
              '| Area | Changed |',
              '|------|---------|',
              `| Core Backend | ${changes.core === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              `| UI Components | ${changes.ui === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              `| Shared Library | ${changes.shared === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              `| Tests | ${changes.tests === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              `| Workflows | ${changes.workflows === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              `| Docker | ${changes.docker === 'true' ? '‚úÖ Yes' : '‚ùå No'} |`,
              ''
            ];
            
            await core.summary.addRaw(summary.join('\n')).write();
