name: Build Artifacts

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.101'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

jobs:
  build:
    name: Build ${{ matrix.runtime }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: MehguViewer-linux-x64
            executable: MehguViewer.Core
          - os: ubuntu-latest
            runtime: linux-arm64
            artifact-name: MehguViewer-linux-arm64
            executable: MehguViewer.Core
          - os: windows-latest
            runtime: win-x64
            artifact-name: MehguViewer-win-x64
            executable: MehguViewer.Core.exe
          - os: macos-15-intel
            runtime: osx-x64
            artifact-name: MehguViewer-osx-x64
            executable: MehguViewer.Core
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: MehguViewer-osx-arm64
            executable: MehguViewer.Core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET workloads
        run: |
          dotnet workload update --skip-sign-check
          dotnet workload install wasm-tools --skip-sign-check

      - name: Publish self-contained single-file executable
        shell: bash
        run: |
          dotnet publish MehguViewer.Core.csproj \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --self-contained true \
            --output ./publish

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p ./artifact
          # Copy executable
          if [ -f "./publish/${{ matrix.executable }}" ]; then
            cp "./publish/${{ matrix.executable }}" ./artifact/
          else
            echo "ERROR: Executable not found at ./publish/${{ matrix.executable }}"
            ls -la ./publish/
            exit 1
          fi
          # Copy wwwroot (required for Blazor UI)
          if [ -d "./publish/wwwroot" ]; then
            cp -r ./publish/wwwroot ./artifact/
          else
            echo "WARNING: wwwroot directory not found"
          fi
          echo "=== Artifact contents ==="
          ls -la ./artifact/
          echo "=== Total size ==="
          du -sh ./artifact/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ./artifact/
          retention-days: 30
          if-no-files-found: error

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Check build results
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = '${{ needs.build.result }}';
            const summary = [
              '## Build Artifacts Summary',
              '',
              '| Platform | Status |',
              '|----------|--------|',
              '| linux-x64 | ' + (buildResult === 'success' ? '✅' : '❌') + ' |',
              '| linux-arm64 | ' + (buildResult === 'success' ? '✅' : '❌') + ' |',
              '| win-x64 | ' + (buildResult === 'success' ? '✅' : '❌') + ' |',
              '| osx-x64 | ' + (buildResult === 'success' ? '✅' : '❌') + ' |',
              '| osx-arm64 | ' + (buildResult === 'success' ? '✅' : '❌') + ' |',
              '',
              'Artifacts are available for download for 30 days.'
            ].join('\n');
            
            await core.summary.addRaw(summary).write();
