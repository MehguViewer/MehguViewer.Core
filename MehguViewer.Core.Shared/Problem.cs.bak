using System.ComponentModel.DataAnnotations;
using System.Text.Json.Serialization;

namespace MehguViewer.Core.Shared;

/// <summary>
/// RFC 7807 Problem Details for HTTP APIs.
/// Provides a standardized format for representing errors in HTTP API responses.
/// </summary>
/// <remarks>
/// This record implements the RFC 7807 specification for machine-readable error details.
/// All MehguViewer APIs must use this format for error responses to ensure consistency.
/// 
/// Example usage:
/// <code>
/// var problem = new Problem(
///     type: "urn:mvn:error:not-found",
///     title: "Resource Not Found",
///     status: 404,
///     detail: "The requested series could not be found",
///     instance: "/api/series/urn:mvn:series:123"
/// );
/// </code>
/// 
/// See: https://datatracker.ietf.org/doc/html/rfc7807
/// </remarks>
/// <param name="type">
/// A URI reference (typically a URN) that identifies the problem type.
/// Should use the format: urn:mvn:error:{error-type}
/// This is the primary identifier for the error category.
/// </param>
/// <param name="title">
/// A short, human-readable summary of the problem type.
/// Should be the same for all occurrences of the same type.
/// </param>
/// <param name="status">
/// The HTTP status code for this occurrence of the problem.
/// Must match the actual HTTP response status code.
/// </param>
/// <param name="detail">
/// A human-readable explanation specific to this occurrence of the problem.
/// Should provide actionable information to help resolve the issue.
/// </param>
/// <param name="instance">
/// A URI reference that identifies the specific occurrence of the problem.
/// Typically the request path that caused the error.
/// </param>
[method: JsonConstructor]
public record Problem(
    [property: JsonPropertyName("type")]
    [Required(ErrorMessage = "Problem type URI is required")]
    string type,
    
    [property: JsonPropertyName("title")]
    [Required(ErrorMessage = "Problem title is required")]
    string title,
    
    [property: JsonPropertyName("status")]
    [Range(100, 599, ErrorMessage = "HTTP status must be between 100 and 599")]
    int status,
    
    [property: JsonPropertyName("detail")]
    string? detail,
    
    [property: JsonPropertyName("instance")]
    [Required(ErrorMessage = "Problem instance is required")]
    string instance
)
{
    /// <summary>
    /// Creates a standardized Problem instance for common error scenarios.
    /// </summary>
    public static class Factory
    {
        /// <summary>
        /// Creates a 400 Bad Request problem.
        /// </summary>
        public static Problem BadRequest(string detail, string instance) => new(
            type: "urn:mvn:error:bad-request",
            title: "Bad Request",
            status: 400,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 401 Unauthorized problem.
        /// </summary>
        public static Problem Unauthorized(string detail, string instance) => new(
            type: "urn:mvn:error:unauthorized",
            title: "Unauthorized",
            status: 401,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 403 Forbidden problem.
        /// </summary>
        public static Problem Forbidden(string detail, string instance) => new(
            type: "urn:mvn:error:forbidden",
            title: "Forbidden",
            status: 403,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 404 Not Found problem.
        /// </summary>
        public static Problem NotFound(string detail, string instance) => new(
            type: "urn:mvn:error:not-found",
            title: "Not Found",
            status: 404,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 409 Conflict problem.
        /// </summary>
        public static Problem Conflict(string detail, string instance) => new(
            type: "urn:mvn:error:conflict",
            title: "Conflict",
            status: 409,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 422 Unprocessable Entity problem.
        /// </summary>
        public static Problem UnprocessableEntity(string detail, string instance) => new(
            type: "urn:mvn:error:unprocessable-entity",
            title: "Unprocessable Entity",
            status: 422,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 429 Too Many Requests problem.
        /// </summary>
        public static Problem TooManyRequests(string detail, string instance) => new(
            type: "urn:mvn:error:too-many-requests",
            title: "Too Many Requests",
            status: 429,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 500 Internal Server Error problem.
        /// </summary>
        public static Problem InternalServerError(string detail, string instance) => new(
            type: "urn:mvn:error:internal-server-error",
            title: "Internal Server Error",
            status: 500,
            detail: detail,
            instance: instance
        );

        /// <summary>
        /// Creates a 503 Service Unavailable problem.
        /// </summary>
        public static Problem ServiceUnavailable(string detail, string instance) => new(
            type: "urn:mvn:error:service-unavailable",
            title: "Service Unavailable",
            status: 503,
            detail: detail,
            instance: instance
        );
    }
}

