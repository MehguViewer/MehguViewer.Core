@page "/groups"
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Groups - MehguViewer</PageTitle>

<div class="taxonomy-page">
    <div class="page-bg"></div>
    
    <div class="page-header">
        <div class="header-left">
            <div class="header-icon groups">
                <MudIcon Icon="@Icons.Material.Filled.Folder" />
            </div>
            <div class="header-text">
                <h1>Groups</h1>
                <p>Organize series into collections and groups</p>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-value">@_groups.Count</span>
                <span class="stat-label">Groups</span>
            </div>
        </div>
    </div>

    <div class="search-section">
        <div class="search-wrapper">
            <MudIcon Icon="@Icons.Material.Filled.Search" Class="search-icon" />
            <input type="text" 
                   @bind="_searchQuery" 
                   @bind:event="oninput"
                   placeholder="Search groups..." 
                   class="search-input" />
            @if (!string.IsNullOrEmpty(_searchQuery))
            {
                <button class="clear-btn" @onclick="@(() => _searchQuery = "")">
                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" />
                </button>
            }
        </div>
    </div>

    @if (_loading)
    {
        <div class="loading-state">
            <div class="loader"></div>
            <span>Loading groups...</span>
        </div>
    }
    else
    {
        <div class="content-container">
            @if (FilteredGroups.Any())
            {
                <div class="items-grid">
                    @foreach (var group in FilteredGroups)
                    {
                        <div class="item-card" @onclick="@(() => FilterByGroup(group.Name))">
                            <div class="item-avatar">
                                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" />
                            </div>
                            <div class="item-info">
                                <span class="item-name">@group.Name</span>
                                @if (!string.IsNullOrEmpty(group.Description))
                                {
                                    <span class="item-desc">@group.Description</span>
                                }
                            </div>
                            <div class="item-stats">
                                <span class="series-count">@group.SeriesCount</span>
                                <span class="series-label">series</span>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <MudIcon Icon="@Icons.Material.Filled.FolderOff" Size="Size.Large" />
                    <h3>No Groups Found</h3>
                    <p>@(string.IsNullOrEmpty(_searchQuery) ? "Groups will appear when series are organized into groups." : $"No groups match '{_searchQuery}'")</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool _loading = true;
    private List<GroupInfo> _groups = new();
    private string _searchQuery = "";

    private IEnumerable<GroupInfo> FilteredGroups => string.IsNullOrWhiteSpace(_searchQuery)
        ? _groups
        : _groups.Where(g => g.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    private async Task LoadGroups()
    {
        _loading = true;
        try
        {
            var taxonomy = await Http.GetFromJsonAsync<TaxonomyResponse>("api/v1/taxonomy");
            if (taxonomy?.groups != null)
            {
                var seriesResponse = await Http.GetFromJsonAsync<SeriesListResponse>("api/v1/series");
                var series = seriesResponse?.data ?? [];

                _groups = taxonomy.groups.Select(group => new GroupInfo
                {
                    Id = group.id,
                    Name = group.name,
                    Description = null, // Groups don't have descriptions in current model
                    SeriesCount = series.Count(s => s.groups?.Any(g => g.name.Equals(group.name, StringComparison.OrdinalIgnoreCase)) == true)
                }).OrderByDescending(g => g.SeriesCount).ThenBy(g => g.Name).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load groups: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void FilterByGroup(string group)
    {
        Navigation.NavigateTo($"/series?group={Uri.EscapeDataString(group)}");
    }

    private class GroupInfo
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string? Description { get; set; }
        public int SeriesCount { get; set; }
    }

    private record TaxonomyResponse(string[] tags, string[] content_warnings, string[] types, Author[] authors, Scanlator[] scanlators, Group[] groups);
    private record SeriesListResponse(Series[] data);
}
