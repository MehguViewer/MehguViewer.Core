<MudPaper Class="pa-6" Elevation="0">
    <MudText Typo="Typo.h6" Class="fw-bold mb-4">Federation Settings</MudText>
    
    <MudGrid Spacing="4">
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Auth Server Connection</MudText>
        </MudItem>
        
        <MudItem xs="12">
            <MudTextField @bind-Value="_authServerUrl" 
                          Label="Auth Server URL" 
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          HelperText="The central auth server for user authentication" />
        </MudItem>
        
        <MudItem xs="12">
            <div class="d-flex gap-2 align-center">
                <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Sync" OnClick="TestConnection" Disabled="@_testing">
                    @if (_testing)
                    {
                        <MudProgressCircular Class="ms-n1 mr-2" Size="Size.Small" Indeterminate="true" />
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </MudButton>
                @if (_connectionStatus != null)
                {
                    <MudChip T="string" Size="Size.Small" Color="@(_connectionStatus == true ? Color.Success : Color.Error)" Variant="Variant.Filled">
                        @(_connectionStatus == true ? "Connected" : "Failed")
                    </MudChip>
                }
            </div>
        </MudItem>
        
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Node Maintainer</MudText>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="_maintainerName" 
                          Label="Maintainer Name" 
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="_maintainerEmail" 
                          Label="Maintainer Email" 
                          InputType="InputType.Email"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
        </MudItem>
        
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Federation Status</MudText>
        </MudItem>
        
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="0" Outlined="true">
                <div class="d-flex align-center gap-4">
                    <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Hub" />
                    </MudAvatar>
                    <div class="flex-grow-1">
                        <MudText Typo="Typo.body1" Class="fw-bold">Federation Network</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            This node can discover and share content with other MehguViewer nodes
                        </MudText>
                    </div>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                        Coming Soon
                    </MudChip>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12">
            <MudAlert Severity="Severity.Info" Dense="true">
                Federation allows your node to participate in the MehguViewer network. 
                Content can be discovered by users from other federated nodes while 
                respecting your privacy and permission settings.
            </MudAlert>
        </MudItem>
    </MudGrid>
    
    <div class="d-flex justify-end mt-6">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Class="ms-n1 mr-2" Size="Size.Small" Indeterminate="true" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </MudButton>
    </div>
</MudPaper>

@code {
    [Parameter]
    public NodeMetadata Metadata { get; set; } = null!;
    
    [Parameter]
    public EventCallback<NodeMetadata> OnSave { get; set; }

    private bool _saving;
    private bool _testing;
    private bool? _connectionStatus;
    private string _authServerUrl = "";
    private string _maintainerName = "";
    private string _maintainerEmail = "";

    protected override void OnParametersSet()
    {
        _authServerUrl = Metadata.auth_server;
        _maintainerName = Metadata.maintainer?.name ?? "";
        _maintainerEmail = Metadata.maintainer?.email ?? "";
    }

    private async Task TestConnection()
    {
        _testing = true;
        _connectionStatus = null;
        
        try
        {
            await Task.Delay(1500); // Simulate network call
            _connectionStatus = !string.IsNullOrEmpty(_authServerUrl);
        }
        catch
        {
            _connectionStatus = false;
        }
        finally
        {
            _testing = false;
        }
    }

    private async Task Save()
    {
        _saving = true;
        var newMetadata = Metadata with 
        { 
            auth_server = _authServerUrl,
            maintainer = new NodeMaintainer(_maintainerName, _maintainerEmail)
        };
        await OnSave.InvokeAsync(newMetadata);
        _saving = false;
    }
}
