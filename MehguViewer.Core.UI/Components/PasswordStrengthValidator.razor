@* Password Strength Validator Component *@
@* Provides real-time validation feedback matching server-side rules *@

<div class="password-validator @Class">
    <MudTextField T="string"
                  Value="@_internalPassword"
                  ValueChanged="@(async (string v) => await OnPasswordChanged(v))"
                  Label="@Label"
                  InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                  Variant="Variant.Outlined"
                  Margin="Margin.Dense"
                  Required="@Required"
                  RequiredError="Password is required"
                  Immediate="true"
                  Adornment="Adornment.End"
                  AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                  OnAdornmentClick="TogglePasswordVisibility" />
    
    @if (ShowStrengthIndicator && !string.IsNullOrEmpty(_internalPassword))
    {
        <div class="strength-container">
            <div class="strength-bar">
                <div class="strength-fill @GetStrengthClass()" style="width: @StrengthPercent%;"></div>
            </div>
            <div class="strength-label">
                @GetStrengthLabel()
            </div>
        </div>
        <div class="requirements-grid">
            <div class="requirement @(HasMinLength ? "met" : "unmet")">
                <MudIcon Icon="@(HasMinLength ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" Size="Size.Small" />
                <span>8+ characters</span>
            </div>
            <div class="requirement @(HasUppercase ? "met" : "unmet")">
                <MudIcon Icon="@(HasUppercase ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" Size="Size.Small" />
                <span>Uppercase</span>
            </div>
            <div class="requirement @(HasLowercase ? "met" : "unmet")">
                <MudIcon Icon="@(HasLowercase ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" Size="Size.Small" />
                <span>Lowercase</span>
            </div>
            <div class="requirement @(HasDigit ? "met" : "unmet")">
                <MudIcon Icon="@(HasDigit ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.RadioButtonUnchecked)" Size="Size.Small" />
                <span>Number</span>
            </div>
        </div>
    }
</div>

@code {
    private bool _showPassword;
    private string _internalPassword = "";
    
    [Parameter] 
    public string Password { get; set; } = "";
    
    [Parameter] public EventCallback<string> PasswordChanged { get; set; }
    [Parameter] public EventCallback<bool> IsValidChanged { get; set; }
    [Parameter] public string Label { get; set; } = "Password";
    [Parameter] public bool Required { get; set; } = true;
    [Parameter] public bool ShowStrengthIndicator { get; set; } = true;
    [Parameter] public string Class { get; set; } = "";
    
    protected override void OnParametersSet()
    {
        if (_internalPassword != Password)
        {
            _internalPassword = Password;
        }
    }
    
    private async Task OnPasswordChanged(string value)
    {
        _internalPassword = value;
        Password = value;
        await PasswordChanged.InvokeAsync(value);
        await IsValidChanged.InvokeAsync(IsValid);
    }
    
    public bool IsValid => HasMinLength && HasUppercase && HasLowercase && HasDigit && (_internalPassword?.Length ?? 0) <= 128;
    
    private bool HasMinLength => (_internalPassword?.Length ?? 0) >= 8;
    private bool HasUppercase => _internalPassword?.Any(char.IsUpper) ?? false;
    private bool HasLowercase => _internalPassword?.Any(char.IsLower) ?? false;
    private bool HasDigit => _internalPassword?.Any(char.IsDigit) ?? false;
    
    private int StrengthPercent
    {
        get
        {
            int score = 0;
            if (HasMinLength) score += 25;
            if (HasUppercase) score += 25;
            if (HasLowercase) score += 25;
            if (HasDigit) score += 25;
            return score;
        }
    }
    
    private string GetStrengthClass() => StrengthPercent switch
    {
        100 => "strong",
        >= 75 => "good",
        >= 50 => "fair",
        _ => "weak"
    };
    
    private string GetStrengthLabel() => StrengthPercent switch
    {
        100 => "Strong",
        >= 75 => "Good",
        >= 50 => "Fair",
        _ => "Weak"
    };
    
    private void TogglePasswordVisibility() => _showPassword = !_showPassword;
    
    /// <summary>
    /// Static helper method to validate password on client-side (matches server rules)
    /// </summary>
    public static (bool IsValid, string? Error) ValidatePassword(string password)
    {
        if (string.IsNullOrEmpty(password))
            return (false, "Password is required");
        
        if (password.Length < 8)
            return (false, "Password must be at least 8 characters");
        
        if (password.Length > 128)
            return (false, "Password must be less than 128 characters");
        
        bool hasUpper = password.Any(char.IsUpper);
        bool hasLower = password.Any(char.IsLower);
        bool hasDigit = password.Any(char.IsDigit);
        
        if (!hasUpper || !hasLower || !hasDigit)
            return (false, "Password must contain uppercase, lowercase, and a number");
        
        return (true, null);
    }
}
