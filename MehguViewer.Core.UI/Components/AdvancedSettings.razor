@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<MudPaper Class="pa-6 glass-card" Elevation="0">
    <MudText Typo="Typo.h6" Class="fw-bold mb-4">Advanced Settings</MudText>
    
    <MudAlert Severity="Severity.Warning" Class="mb-4" Variant="Variant.Outlined">
        These settings are for advanced users. Incorrect configuration may cause issues.
    </MudAlert>
    
    <MudGrid Spacing="4">
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Performance</MudText>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudNumericField @bind-Value="_maxConcurrentJobs" 
                             Label="Max Concurrent Jobs" 
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="1" Max="10"
                             HelperText="Number of simultaneous ingestion jobs" />
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudNumericField @bind-Value="_requestTimeout" 
                             Label="Request Timeout (seconds)" 
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="5" Max="300" />
        </MudItem>
        
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Logging</MudText>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudSelect @bind-Value="_logLevel" 
                       Label="Log Level"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense">
                <MudSelectItem Value="@("Debug")">Debug</MudSelectItem>
                <MudSelectItem Value="@("Information")">Information</MudSelectItem>
                <MudSelectItem Value="@("Warning")">Warning</MudSelectItem>
                <MudSelectItem Value="@("Error")">Error</MudSelectItem>
            </MudSelect>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudNumericField @bind-Value="_logRetentionDays" 
                             Label="Log Retention (days)" 
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="1" Max="365" />
        </MudItem>
        
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Language Filter</MudText>
        </MudItem>
        
        <MudItem xs="12">
            <MudChipSet T="string" @bind-SelectedValues="_selectedLanguages" SelectionMode="SelectionMode.MultiSelection" Variant="Variant.Outlined">
                <MudChip Text="English" Value="@("en")" />
                <MudChip Text="Japanese" Value="@("ja")" />
                <MudChip Text="Korean" Value="@("ko")" />
                <MudChip Text="Chinese" Value="@("zh")" />
                <MudChip Text="Spanish" Value="@("es")" />
                <MudChip Text="Portuguese" Value="@("pt")" />
            </MudChipSet>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                Default languages shown to users. Users can override in their preferences.
            </MudText>
        </MudItem>
        
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Error">Danger Zone</MudText>
        </MudItem>
        
        @* Reset All Data *@
        <MudItem xs="12">
            <div class="danger-card">
                <div class="danger-content">
                    <div class="danger-icon">
                        <MudIcon Icon="@Icons.Material.Filled.DeleteSweep" Size="Size.Large" />
                    </div>
                    <div class="danger-text">
                        <MudText Typo="Typo.body1" Class="fw-bold">Reset All Data</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.6);">
                            Delete all series, assets, collections, and user data. Database schema will be preserved.
                        </MudText>
                    </div>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever" OnClick="ConfirmResetData" Disabled="_resetting">
                        @if (_resettingData) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Reset Data
                    </MudButton>
                </div>
            </div>
        </MudItem>

        @* Reset Database *@
        <MudItem xs="12">
            <div class="danger-card critical">
                <div class="danger-content">
                    <div class="danger-icon">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Large" />
                    </div>
                    <div class="danger-text">
                        <MudText Typo="Typo.body1" Class="fw-bold">Reset Database</MudText>
                        <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.6);">
                            Drop all tables and reset to initial state. You will need to run setup wizard again.
                        </MudText>
                    </div>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Warning" OnClick="ConfirmResetDatabase" Disabled="_resetting">
                        @if (_resettingDb) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Reset Database
                    </MudButton>
                </div>
            </div>
        </MudItem>
    </MudGrid>
    
    <div class="d-flex justify-end mt-6">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Class="ms-n1 mr-2" Size="Size.Small" Indeterminate="true" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </MudButton>
    </div>
</MudPaper>

@* Password Confirmation Dialog *@
<MudDialog @bind-Visible="_showPasswordDialog" Options="new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true }">
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Error" />
            <MudText Typo="Typo.h6">Confirm Admin Password</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Outlined">
            @_dialogMessage
        </MudAlert>
        <MudTextField @bind-Value="_confirmPassword" 
                     Label="Admin Password" 
                     Variant="Variant.Outlined"
                     InputType="InputType.Password"
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Filled.Lock"
                     HelperText="Enter your admin password to confirm this action" />
        @if (!string.IsNullOrEmpty(_passwordError))
        {
            <MudText Color="Color.Error" Typo="Typo.caption" Class="mt-2">@_passwordError</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="ClosePasswordDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ExecuteReset" Disabled="_resetting">
            @if (_resetting) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
            Confirm Reset
        </MudButton>
    </DialogActions>
</MudDialog>

@using MehguViewer.Core.UI.Services

@code {
    [Parameter]
    public SystemConfig Config { get; set; } = null!;
    
    [Parameter]
    public EventCallback<SystemConfig> OnSave { get; set; }

    private bool _saving;
    private bool _resetting;
    private bool _resettingData;
    private bool _resettingDb;
    private int _maxConcurrentJobs = 3;
    private int _requestTimeout = 30;
    private string _logLevel = "Information";
    private int _logRetentionDays = 30;
    private IReadOnlyCollection<string> _selectedLanguages = new List<string> { "en" };

    // Password dialog
    private bool _showPasswordDialog;
    private string _confirmPassword = "";
    private string _passwordError = "";
    private string _dialogMessage = "";
    private string _resetAction = "";

    protected override void OnParametersSet()
    {
        _selectedLanguages = Config.default_language_filter?.ToList() ?? new List<string> { "en" };
    }

    private async Task Save()
    {
        _saving = true;
        var newConfig = Config with 
        { 
            default_language_filter = _selectedLanguages.ToArray()
        };
        await OnSave.InvokeAsync(newConfig);
        _saving = false;
    }

    private void ConfirmResetData()
    {
        _resetAction = "data";
        _dialogMessage = "This will permanently delete ALL series, assets, collections, jobs, and user data. This action cannot be undone!";
        _confirmPassword = "";
        _passwordError = "";
        _showPasswordDialog = true;
    }

    private void ConfirmResetDatabase()
    {
        _resetAction = "database";
        _dialogMessage = "This will DROP ALL TABLES and reset the node to initial state. You will be redirected to the setup wizard. This action cannot be undone!";
        _confirmPassword = "";
        _passwordError = "";
        _showPasswordDialog = true;
    }

    private void ClosePasswordDialog()
    {
        _showPasswordDialog = false;
        _confirmPassword = "";
        _passwordError = "";
    }

    private async Task ExecuteReset()
    {
        if (string.IsNullOrEmpty(_confirmPassword))
        {
            _passwordError = "Password is required";
            return;
        }

        _resetting = true;
        _passwordError = "";

        try
        {
            var endpoint = _resetAction == "data" ? "api/v1/admin/reset-data" : "api/v1/admin/reset-database";
            var request = new ResetRequest(_confirmPassword);
            
            if (_resetAction == "data") _resettingData = true;
            else _resettingDb = true;

            var response = await Http.PostAsJsonAsync(endpoint, request);
            
            if (response.IsSuccessStatusCode)
            {
                _showPasswordDialog = false;
                
                if (_resetAction == "database")
                {
                    // Clear auth token and redirect to setup
                    await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");
                    Http.DefaultRequestHeaders.Authorization = null;
                    Snackbar.Add("Database reset complete. Redirecting to setup...", Severity.Success);
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/setup", true);
                }
                else
                {
                    Snackbar.Add("All data has been reset successfully.", Severity.Success);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _passwordError = response.StatusCode == System.Net.HttpStatusCode.Unauthorized 
                    ? "Invalid password" 
                    : "Reset failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _passwordError = "An error occurred. Please try again.";
            Console.WriteLine($"Reset error: {ex.Message}");
        }
        finally
        {
            _resetting = false;
            _resettingData = false;
            _resettingDb = false;
        }
    }

    private record ResetRequest(string password_hash);
}
